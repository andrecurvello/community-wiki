= Introduction =

ORPSoC is the '''O'''penRISC '''R'''eference '''P'''latform '''S'''ystem-'''o'''n-'''C'''hip. It is intended to be a development and verification environment for IP cores and SoC designs. It is a collaboratively developed project. 

As a development platform it should provide a modular, easy to use environment to perform RTL development with push-button simulation and synthesis flows. A basic software build environment is also present to support OpenRISC development in simulation and on target. The project should be easy enough for users, both new and experienced, to get started with OpenRISC designs and develop quickly and collaborate easily.

= How it works =

ORPSoC provides both system description files and the scripts to simulate and build these systems.

ORPSoC is split into more than one repository. The scripts and automation tools (<tt>orpsoc</tt>) are separate from the system and core descriptions (<tt>orpsoc-cores</tt>).

The primary interface with ORPSoC is via the <tt>orpsoc</tt> command-line executable. Users edit HDL source code and system configuration files before launching <tt>orpsoc</tt> to either launch simulation or FPGA image generation.

= Download =

The <tt>orpsoc</tt> and <tt>orpsoc-cores</tt> repositories should be set up alongside each other.

== ORPSoC ==

This is the scripting and automation component of ORPSoC.

=== Latest Release ===

The latest release '''ORPSoC 3.1''' [ftp://ocuser:ocuser@openrisc.opencores.org/orpsoc/orpsoc-3.1.tar.gz can be downloaded here].

=== Repository ===

The ORPSoC source is hosted under the OpenRISC organisation on github - [https://github.com/openrisc/orpsoc https://github.com/openrisc/orpsoc]

Clone a copy of the repository with git like so:

 git clone https://github.com/openrisc/orpsoc.git

== ORPSoC cores ==

This contains the IP core and system configuration information.

=== Repository ===

The ORPSoC cores source is hosted under the OpenRISC organisation on github - [https://github.com/openrisc/orpsoc https://github.com/openrisc/orpsoc-cores]

Clone a copy of the repository with git like so:

 git clone https://github.com/openrisc/orpsoc-cores.git

= Install =

The only component which can be installed is the <tt>orpsoc</tt> tool. It is possible to use the tool without installing it, too. See below.

== ORPSoC ==

'''Note''': If you have downloaded the [[#Latest_Release|latest release]] then you may omit the <tt>autoreconf -i</tt> step below as it has already been run before archiving.

From within the <tt>orpsoc</tt> directory run the following:

 autoreconf -i
 ./configure
 make
 make install

Once this is done, then the <tt>orpsoc</tt> tool will be available.

=== Without installing ===

It's possible to just export the <tt><path to orpsoc location>orpsoc/bin</tt> to your $PATH variable to able to use <tt>orpsoc</tt>

= Using =

ORPSoC can simply be used by going to the <tt>orpsoc-cores</tt> directory and using the <tt>orpsoc</tt> tool. eg. for a list of commands:

 ~/git/orpsoc-cores$ orpsoc --help


=Rationale=
The following problems with current ORPSoC have been identified. The next version will try to rectify these issues

* Current version of ORPSoC require local copies of all cores which duplicates a lot of code and creates undocumented deviations from the upstream versions.

* Each board port contain files that could be centralized for easier maintenance.

* ORPSoC contain some basic C library functions that are also available in newlib. This also creates additional problems with incompatibility between software built with liborpsoc and newlib.

* The reference build, which is really a non-technology-specific board build, is treated as a special board build which complicates the hierarchy

* It's easy to get lost in the tree and there is no way to go from setup to simulation to implementation without moving around in the ORPSoC tree

* It's hard to know what is expected to provide when a new board port is added

* ORPSoC is hidden in the or1k tree, which makes it harder to find.

=Implementation=

==Project Structure==

*<root>/
**bench/ Main ORPSoC testbench
**boards/ Contain all board-specific directories
***digilent-atlys/
***ordb2a/
***generic/
***...
***de0-nano
**config/ ORPSoC configuration files
**cores/
***or1200
***simple_spi
***...
***uart16550
**scripts/ Makefile snippets and other ORPSoC scripts
**sw/ ORPSoC-specific software

==Software managment==
Structure
* sw/
** apps/ Example apps to run on board or in simulation
** tests/ Source code for test cases
** utils/ Utility programs for ORPSoC

==Handling of external cores==
External cores from opencores or other locations will be pulled in when needed, and patched to work in ORPSoC. Each core will live in a separate directory with the following structure:
* <core_name>
**driver/ .c/.h/.S files for bare-metal driver
**core/ Upstream core
**patches/ ORPSoC-specific patches for core
**Makefile

Makefile should contain the following rules:
* fetch Get the core from it's upstream repository
* patch Apply core-specific patches
* driver Build an object of the bare-metal driver

Each core will need a Makefile in it's upstream root directory that need the following rules
* list-rtl-files Return a list of RTL files in core
* list-include-dirs Return a list of include directories in core
* list-tb-files Return a list of files needed for simulation
This makefile can be included as a patch if it is not in the upstream core

==Board-specific configuration==
Each board is required to have a Makefile with the following rules
* config Initialize all cores
* rtl-test Launch a simulation with a defined test case
* netlist Generate a post-synthesis netlist
* loadmodule Generate an image that can be downloaded to an FPGA
Apart from that, there are no restrictions, but the following structure is recommended:
* <board root>
**data/ General input files such as simulation configurations, constraint files, coregen descriptions
**rtl/ ORPSoC top-level, clock generation and other board-specific files that are not found in the cores
**tb/ Board-specific test-bench top-level and other testbench related files
**board.conf All board-specific parameters
**Makefile Implements the required as well as optional board-specific makefile targets

=Workflow=

==Quick start. Build a ready-made FPGA image==
From the project root
<code><br>make config_<board_name>
<br>make loadmodule</code>
The above code will select the configuration file for the selected board and save it in config/board.conf. It will then use the default synthesis and PAR tools to build a FPGA image

==Quick start. Simulation==
From the project root
<code><br>make config_<board_name>
<br>make rtl-tests</code>
The above code will select the configuration file for the selected board and save it in config/board.conf. It will then use the default simulation tool to run through all the RTL tests

==Adding a new core to a board build==
TBD

==Building a bare-metal program with ORPSoC drivers==
TBD
==Overriding a central core with a local version==
TBD
==Adding support for a new core in ORPSoC==
TBD
==Creating and updating patches==
Quilt is needed for patching of the cores. This describes how to add an ORPSoC-specific patch to a core
Go to <code><core root></code>
If there are any previous patches, make sure they are all applied before you start
<code><br>quilt push -a<br></code>
Decide a name for the patch and a number that follows the naming scheme. In ORPSoC this is <nnnn>-<name-of-patch>.diff, where nnnn is a four-digit number that follows the latest available patch. Create the patch with:
<code><br>quilt new <nnnn>-<name-of-patch>.diff (e.g. quilt new 0003-remove-defines.diff)<br></code>

The state of all files that are to be changed must be recorded by quilt before-hand so that the original state is known.
There are two ways to make changes to files

1. Use quilt edit <filename> This will make quilt automatically record the original state, and add the changes to the patch

2. Use quilt add <filename> before the file is added. This will make quilt record the original state, and any editor can now be used

When the editing is done, the patch can be reviewed with <code>quilt diff</code>

To actually create the patch, <code>quilt refresh</code>. A new patch can now be created with <code>quilt new <nnnn+1>-<name-of-next-patch>.diff</code>

==Porting an ORPSoCv2 board port to ORPSoCv3==
TBD

==Other==

* ORPSoC will be living in a separate repository. This will increase visibility and also make it easier to use other CPU implementations.

=Status=
==Currently supported==

===Simulation===
{| border="1" cellspacing="0" cellpadding="2"
! Tool
! Supported
|-
|Icarus    || In progress
|-
|Isim      || In progress
|-
|Modelsim  || No
|-
|Verilator || No
|}

===Synthesis===
{| border="1" cellspacing="0" cellpadding="2"
! Tool
! Supported
|-
|CoreGen  || Yes
|-
|Quartus  || No
|-
|Synplify || No
|-
|XST      || Yes
|}

===Place and route===
{| border="1" cellspacing="0" cellpadding="2"
! Tool
! Supported
|-
|ISE            || Yes
|-
|Quartus        || No
|-
|Actel Designer || No
|}

===Boards===
{| border="1" cellspacing="0" cellpadding="2"
! Board
! Simulation
! Synthesis
! Place and route
|-
|Digilent Atlys    || In progress || XST || ISE
|-
|generic  || Icarus      || No  || No
|-
|ORSoC ordb2a   || No          || No  || No
|}

==Work items==
===Software support===
* Set up software structure
* Move drivers to core roots
* Adapt simulation scripts from ORPSoCv2
* Merge board and sim tests and add #ifdefs where needed
===Test bench===
* Clean up define files
===Infrastructure===
* Add isim scripts to simulate Xilinx builds
* Adapt Altera and Actel build scripts from ORPSoCv2

=Open issues=
* Investigate if quilt or git be used for managing patches
* Rename loadmodule target to something more sensible. (programmingfile, fpgaimage..?)
* What can be done to ease additions or removals of cores in the top-level? IP-Xact is under consideration for generation of arbiters and top-level file
* boards is not a good name, as there can be several configurations for a physical board, or a design may be purely for verification purposes only and thus not intended to end up on a board. systems, designs or configurations have been proposed

=Discussion=

The original discussion can be found here [[ORPSoCv3InitialDiscussion]]
